<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–≥—Ä–µ—Å—É</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --background-dark: linear-gradient(135deg, #1A2A44 0%, #0D0D1A 100%);
            --accent-teal: #00FFD1;
            --accent-purple: #A100FF;
            --accent-gold: #FFD700;
            --text-primary-dark: #E0E7FF;
            --text-secondary: #A0AEC0;
            --glass-bg-dark: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(0, 255, 209, 0.3);
            --neon-glow: 0 0 10px #00FFD1, 0 0 20px #00FFD1, 0 0 30px #00FFD1;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--accent-teal); }
            50% { box-shadow: 0 0 20px var(--accent-teal); }
            100% { box-shadow: 0 0 5px var(--accent-teal); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glow-pulse {
            0% { box-shadow: 0 0 5px #FFD700; }
            50% { box-shadow: 0 0 20px #FFD700; }
            100% { box-shadow: 0 0 5px #FFD700; }
        }

        html, body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Orbitron', sans-serif;
            background: var(--background-dark);
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1593079831268-3381b0db4a77?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary-dark);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0.5rem auto;
            padding: 0.75rem;
            background: var(--glass-bg-dark);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            border-radius: 15px;
            transition: background 0.5s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        h1 {
            color: var(--accent-teal);
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.75rem;
            text-shadow: 0 0 10px #00FFD1, 0 0 20px #00FFD1;
        }

        .form-group {
            margin-bottom: 0.5rem;
            position: relative;
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.2rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--glass-border);
            border-radius: 5px;
            background: var(--glass-bg-dark);
            color: var(--text-primary-dark);
            font-size: 0.95rem;
            outline: none;
            transition: box-shadow 0.3s;
        }

        input:focus, select:focus {
            box-shadow: var(--neon-glow);
        }

        .checkbox-group, .range-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-group input, .range-group input {
            width: auto;
        }

        .range-group input[type="range"] {
            width: 200px;
        }

        .forecast-button {
            background: var(--accent-teal);
            border: 1px solid var(--accent-teal);
            padding: 0.75rem 1.5rem;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 0.5rem auto;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .forecast-button:hover {
            box-shadow: var(--neon-glow);
            transform: scale(1.05);
        }

        .progress-container {
            margin-top: 0.5rem;
            text-align: center;
        }

        .progress-container label {
            display: inline-block;
            color: var(--accent-gold);
            margin-bottom: 0.2rem;
        }

        progress {
            width: 100%;
            height: 20px;
            border-radius: 5px;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border);
        }

        progress::-webkit-progress-bar {
            background: var(--glass-bg-dark);
            border-radius: 5px;
        }

        progress::-webkit-progress-value {
            background: var(--accent-teal);
            border-radius: 5px;
        }

        progress::-moz-progress-bar {
            background: var(--accent-teal);
            border-radius: 5px;
        }

        .chart-container {
            margin-top: 0.75rem;
            position: relative;
            height: 400px;
            width: 100%;
        }

        .ai-comment, .recommendations, .pace-indicator, .motivation-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--glass-bg-dark);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary-dark);
        }

        .recommendations ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }

        .pace-indicator {
            text-align: center;
            color: var(--accent-gold);
        }

        .motivation-message {
            text-align: center;
            color: var(--accent-teal);
            animation: fadeInUp 1s ease-out, glow 2s infinite;
        }

        .target-date {
            margin-top: 0.5rem;
            text-align: center;
            color: var(--accent-gold);
        }

        .back-button {
            padding: 0.5rem 1rem;
            color: var(--accent-gold);
            cursor: pointer;
            border: 1px solid var(--glass-border);
            border-radius: 5px;
            background: var(--accent-purple);
            text-align: center;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
            display: block;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            box-shadow: var(--neon-glow);
            transform: scale(1.05);
        }

        .updated {
            animation: glow-pulse 1.5s ease-out;
        }

        .clear-button {
            background: var(--accent-purple);
            border: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            color: var(--accent-gold);
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .clear-button:hover {
            box-shadow: var(--neon-glow);
            transform: scale(1.05);
        }

        .tooltip {
            position: absolute;
            background: rgba(26, 42, 68, 0.9);
            color: var(--text-primary-dark);
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            white-space: nowrap;
            pointer-events: none;
        }

        .form-group:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .tooltip.top {
            top: -2.5rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip.bottom {
            bottom: -2.5rem;
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip.left {
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
        }

        .tooltip.right {
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
                margin: 0.25rem;
            }
            .chart-container {
                height: 300px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .forecast-button {
                font-size: 1rem;
            }
            .tooltip {
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="clear-button" onclick="clearData()">–û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ</button>
        <h1>–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–≥—Ä–µ—Å—É</h1>
        <div class="form-group">
            <label for="age">–í—ñ–∫ (—Ä–æ–∫–∏) üïí<span class="tooltip top">–í—ñ–∫ –≤–ø–ª–∏–≤–∞—î –Ω–∞ –±–∞–∑–æ–≤–∏–π –º–µ—Ç–∞–±–æ–ª—ñ–∑–º</span></label>
            <input type="number" id="age" placeholder="–í–≤–µ–¥–∏ —Å–≤—ñ–π –≤—ñ–∫">
        </div>
        <div class="form-group">
            <label for="height">–ó—Ä—ñ—Å—Ç (—Å–º) üìè<span class="tooltip top">–í–∏—Å–æ—Ç–∞ —Ç—ñ–ª–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ BMR</span></label>
            <input type="number" id="height" placeholder="–í–≤–µ–¥–∏ —Å–≤—ñ–π –∑—Ä—ñ—Å—Ç">
        </div>
        <div class="form-group">
            <label for="gender">–°—Ç–∞—Ç—å üë§<span class="tooltip top">–í–∏–±—ñ—Ä —Å—Ç–∞—Ç—ñ –¥–ª—è –∫–æ—Ä–µ–∫—Ü—ñ—ó BMR</span></label>
            <select id="gender">
                <option value="male">–ß–æ–ª–æ–≤—ñ–∫</option>
                <option value="female">–ñ—ñ–Ω–∫–∞</option>
            </select>
        </div>
        <div class="form-group">
            <label for="currentWeight">–ü–æ—Ç–æ—á–Ω–∞ –≤–∞–≥–∞ (–∫–≥) üèãÔ∏è<span class="tooltip top">–í–∞—à–∞ –ø–æ—Ç–æ—á–Ω–∞ –≤–∞–≥–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É</span></label>
            <input type="number" id="currentWeight" placeholder="–í–≤–µ–¥–∏ –ø–æ—Ç–æ—á–Ω—É –≤–∞–≥—É">
        </div>
        <div class="form-group">
            <label for="targetWeight">–ë–∞–∂–∞–Ω–∞ –≤–∞–≥–∞ (–∫–≥) üéØ<span class="tooltip top">–ú–µ—Ç–∞, –¥–æ —è–∫–æ—ó –ø—Ä–∞–≥–Ω–µ—Ç–µ</span></label>
            <input type="number" id="targetWeight" placeholder="–í–≤–µ–¥–∏ –±–∞–∂–∞–Ω—É –≤–∞–≥—É">
        </div>
        <div class="form-group">
            <label for="currentCalories">–ü–æ—Ç–æ—á–Ω–∞ –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å (–∫–∫–∞–ª/–¥–µ–Ω—å) üî•<span class="tooltip top">–°–∫—ñ–ª—å–∫–∏ –∫–∞–ª–æ—Ä—ñ–π –≤–∏ —Å–ø–æ–∂–∏–≤–∞—î—Ç–µ —â–æ–¥–Ω—è</span></label>
            <input type="number" id="currentCalories" placeholder="–í–≤–µ–¥–∏ –ø–æ—Ç–æ—á–Ω—É –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å">
        </div>
        <div class="form-group">
            <label for="targetCalories">–¶—ñ–ª—å–æ–≤–∞ –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å (–∫–∫–∞–ª/–¥–µ–Ω—å) üçΩÔ∏è<span class="tooltip top">–ü–ª–∞–Ω–æ–≤–∞ –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å –¥–ª—è –º–µ—Ç–∏</span></label>
            <input type="number" id="targetCalories" placeholder="V–≤–µ–¥–∏ —Ü—ñ–ª—å–æ–≤—É –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å">
        </div>
        <div class="form-group">
            <label for="workoutsPerWeek">–¢—Ä–µ–Ω—É–≤–∞–Ω—å –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å üí™<span class="tooltip top">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–µ–Ω—É–≤–∞–Ω—å –≤–ø–ª–∏–≤–∞—î –Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∏ –∫–∞–ª–æ—Ä—ñ–π</span></label>
            <input type="number" id="workoutsPerWeek" placeholder="–í–≤–µ–¥–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–µ–Ω—É–≤–∞–Ω—å –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å">
        </div>
        <div class="form-group">
            <label for="weeklyWeight">–í–∞–≥–∞ —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è (–∫–≥) ‚öñÔ∏è<span class="tooltip top">–û–Ω–æ–≤–ª—é–π—Ç–µ –≤–∞–≥—É —â–æ—Ç–∏–∂–Ω—è –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ</span></label>
            <div class="flex gap-2">
                <input type="number" id="weeklyWeight" placeholder="–í–≤–µ–¥–∏ –≤–∞–≥—É —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è">
                <button class="forecast-button text-sm py-2" onclick="addWeeklyWeight()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∞–≥—É</button>
            </div>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="simulateExtraWorkout">
            <label for="simulateExtraWorkout">–î–æ–¥–∞—Ç–∏ —â–µ 1 —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è/—Ç–∏–∂–¥–µ–Ω—å üí•</label>
        </div>
        <div class="range-group">
            <label for="simCal">–°–∏–º—É–ª—è—Ü—ñ—è: –∑–º—ñ–Ω–∞ –∫–∞–ª–æ—Ä—ñ–π –Ω–∞ üå°Ô∏è</label>
            <input type="range" id="simCal" min="-500" max="500" step="50" value="0">
            <span id="simCalValue">0</span> –∫–∫–∞–ª
        </div>
        <button class="forecast-button" onclick="calculateForecast()">–ü—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–≥—Ä–µ—Å—É</button>
        <div class="progress-container">
            <label id="progressLabel">üîã –ü—Ä–æ–≥—Ä–µ—Å: 0% –¥–æ —Ü—ñ–ª—ñ</label>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        <div class="target-date" id="targetDate"></div>
        <div class="ai-comment" id="aiComment"></div>
        <div class="pace-indicator" id="paceIndicator"></div>
        <div class="recommendations" id="recommendations">
            <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:</h3>
            <ul id="recommendationsList"></ul>
        </div>
        <div class="motivation-message" id="motivationMessage"></div>
        <button class="back-button" onclick="window.location.href='/profile'">–ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é</button>
    </div>

    <script>
        let chart = null;
        let initialWeight = null;
        let weightHistory = [];
        let forecastData = [];
        let targetWeightValue = null;

        const { Chart } = window;
        if (typeof window.ChartAnnotation !== 'undefined') {
            Chart.register(window.ChartAnnotation);
        } else {
            console.warn('ChartAnnotation –ø–ª–∞–≥—ñ–Ω –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ê–Ω–æ—Ç–∞—Ü—ñ—ó –Ω–∞ –≥—Ä–∞—Ñ—ñ–∫—É –±—É–¥—É—Ç—å –≤—ñ–¥–∫–ª—é—á–µ–Ω—ñ.');
        }

        const ctx = document.getElementById('progressChart').getContext('2d');

        const motivationalQuotes = [
            "–¢–∏ —Å–∏–ª—å–Ω—ñ—à–∏–π, –Ω—ñ–∂ –¥—É–º–∞—î—à! –ü—Ä–æ–¥–æ–≤–∂—É–π —Ä—É—Ö–∞—Ç–∏—Å—è –≤–ø–µ—Ä–µ–¥! üí™",
            "–ö–æ–∂–µ–Ω –∫—Ä–æ–∫ –Ω–∞–±–ª–∏–∂–∞—î —Ç–µ–±–µ –¥–æ –º–µ—Ç–∏! üåü",
            "–¢–≤–æ—è –≤—ñ–¥–¥–∞–Ω—ñ—Å—Ç—å –≤—Ä–∞–∂–∞—î ‚Äî —Ç—Ä–∏–º–∞–π —Ç–µ–º–ø! üî•",
            "–ú–∞–ª–µ–Ω—å–∫—ñ –ø–µ—Ä–µ–º–æ–≥–∏ ‚Äî —Ü–µ —Ç–≤—ñ–π —à–ª—è—Ö –¥–æ —É—Å–ø—ñ—Ö—É! üéâ"
        ];

        function showToast(message, callback) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px;
                background: #00FFD1; color: black; padding: 10px 20px;
                border-radius: 8px; font-weight: bold; z-index: 9999;
                box-shadow: 0 0 10px #00FFD1;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
                if (callback) callback();
            }, 3000);
        }

        function clearData() {
            try {
                localStorage.removeItem('progressForecastData');
                showToast('‚úÖ –î–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ!', () => {
                    location.reload();
                });
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö:', error);
                showToast('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ –¥–∞–Ω–∏—Ö');
            }
        }

        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('progressForecastData')) || {};
            document.getElementById('age').value = savedData.age || '';
            document.getElementById('height').value = savedData.height || '';
            document.getElementById('gender').value = savedData.gender || 'male';
            document.getElementById('currentWeight').value = savedData.currentWeight || '';
            document.getElementById('targetWeight').value = savedData.targetWeight || '';
            document.getElementById('currentCalories').value = savedData.currentCalories || '';
            document.getElementById('targetCalories').value = savedData.targetCalories || '';
            document.getElementById('workoutsPerWeek').value = savedData.workoutsPerWeek || '';
            initialWeight = savedData.initialWeight || null;
            weightHistory = savedData.weightHistory || [];
            if (savedData.chartData) {
                forecastData = savedData.chartData.data;
                renderChart(savedData.chartData.labels, savedData.chartData.data, savedData.actualData || []);
                document.getElementById('targetDate').textContent = savedData.targetDate || '';
                document.getElementById('aiComment').textContent = savedData.aiComment || '';
                document.getElementById('paceIndicator').textContent = savedData.paceIndicator || '';
                document.getElementById('recommendationsList').innerHTML = savedData.recommendations || '';
                document.getElementById('motivationMessage').textContent = savedData.motivationMessage || '';
            }
            updateProgressBar();
            document.getElementById('motivationMessage').textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        }

        function saveData() {
            const actualData = weightHistory.map(entry => entry.weight);
            const data = {
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                gender: document.getElementById('gender').value,
                currentWeight: document.getElementById('currentWeight').value,
                targetWeight: document.getElementById('targetWeight').value,
                currentCalories: document.getElementById('currentCalories').value,
                targetCalories: document.getElementById('targetCalories').value,
                workoutsPerWeek: document.getElementById('workoutsPerWeek').value,
                initialWeight: initialWeight,
                weightHistory: weightHistory,
                chartData: chart ? { labels: chart.data.labels, data: chart.data.datasets[0].data } : null,
                actualData: chart && chart.data.datasets[1] ? chart.data.datasets[1].data : [],
                targetDate: document.getElementById('targetDate').textContent,
                aiComment: document.getElementById('aiComment').textContent,
                paceIndicator: document.getElementById('paceIndicator').textContent,
                recommendations: document.getElementById('recommendationsList').innerHTML,
                motivationMessage: document.getElementById('motivationMessage').textContent
            };
            localStorage.setItem('progressForecastData', JSON.stringify(data));
        }

        function addWeeklyWeight() {
            const weeklyWeight = parseFloat(document.getElementById('weeklyWeight').value);
            if (!weeklyWeight) {
                console.log('–í–∞–≥–∞ —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è –Ω–µ –≤–≤–µ–¥–µ–Ω–∞.');
                return;
            }
            const week = weightHistory.length + 1;
            weightHistory.push({ week: week, weight: weeklyWeight });
            document.getElementById('weeklyWeight').value = '';
            document.getElementById('currentWeight').value = weeklyWeight;
            updateProgressBar();

            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('updated');
            setTimeout(() => {
                progressBar.classList.remove('updated');
            }, 1500);
            calculateForecast();
            showToast('‚úÖ –í–∞–≥—É –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }

        function updateProgressBar() {
            const currentWeight = parseFloat(document.getElementById('currentWeight').value);
            const targetWeight = parseFloat(document.getElementById('targetWeight').value);
            if (!initialWeight) initialWeight = currentWeight;
            if (!currentWeight || !targetWeight || !initialWeight) {
                console.log('–ù–µ –≤–∏—Å—Ç–∞—á–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä—É:', { currentWeight, targetWeight, initialWeight });
                return;
            }

            const totalChange = initialWeight - targetWeight;
            const currentChange = initialWeight - currentWeight;
            let progress = (currentChange / totalChange) * 100;
            progress = totalChange < 0 ? 100 - progress : progress;
            progress = Math.min(Math.max(progress, 0), 100);
            document.getElementById('progressBar').value = progress;
            document.getElementById('progressLabel').textContent = `üîã –ü—Ä–æ–≥—Ä–µ—Å: ${progress.toFixed(1)}% –¥–æ —Ü—ñ–ª—ñ`;
        }

        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                return 10 * weight + 6.25 * height - 5 * age - 161;
            }
        }

        function calculateForecast() {
            const age = parseInt(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const gender = document.getElementById('gender').value;
            let currentWeight = parseFloat(document.getElementById('currentWeight').value);
            const targetWeight = parseFloat(document.getElementById('targetWeight').value);
            const currentCalories = parseFloat(document.getElementById('currentCalories').value);
            let targetCalories = parseFloat(document.getElementById('targetCalories').value);
            let workoutsPerWeek = parseInt(document.getElementById('workoutsPerWeek').value);
            const simulateExtraWorkout = document.getElementById('simulateExtraWorkout').checked;
            const simCal = parseInt(document.getElementById('simCal').value);
            const aiComment = document.getElementById('aiComment');
            const targetDateEl = document.getElementById('targetDate');
            const paceIndicator = document.getElementById('paceIndicator');
            const recommendationsList = document.getElementById('recommendationsList');
            const motivationMessage = document.getElementById('motivationMessage');

            console.log('–í–≤–µ–¥–µ–Ω—ñ –¥–∞–Ω—ñ:', {
                age, height, gender, currentWeight, targetWeight,
                currentCalories, targetCalories, workoutsPerWeek, simCal
            });

            if (!age || !height || !currentWeight || !targetWeight || !currentCalories || !targetCalories || !workoutsPerWeek) {
                aiComment.textContent = '–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω–∏ –≤—Å—ñ –ø–æ–ª—è.';
                console.log('–ù–µ –≤—Å—ñ –ø–æ–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ.');
                return;
            }

            if (initialWeight === null) initialWeight = currentWeight;
            updateProgressBar();

            if (simulateExtraWorkout) workoutsPerWeek += 1;
            targetCalories += simCal;
            const extraCaloriesBurned = simulateExtraWorkout ? 200 : 0;
            let calorieDeficit = currentCalories - targetCalories + extraCaloriesBurned;
            if (calorieDeficit === 0) {
                aiComment.textContent = '–î–µ—Ñ—ñ—Ü–∏—Ç –∫–∞–ª–æ—Ä—ñ–π –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ 0. –ó–º—ñ–Ω–∏ –∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å –∞–±–æ –¥–æ–¥–∞–π –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å.';
                console.log('–î–µ—Ñ—ñ—Ü–∏—Ç –∫–∞–ª–æ—Ä—ñ–π = 0.');
                return;
            }

            const weeks = 24;
            const labels = Array.from({ length: weeks + 1 }, (_, i) => i);
            const data = [];
            let current = currentWeight;
            let weeksToTarget = 0;

            for (let i = 0; i <= weeks; i++) {
                data.push(current);
                const bmr = calculateBMR(current, height, age, gender);
                const activityFactor = 1.2 + (workoutsPerWeek * 0.1);
                const tdee = bmr * activityFactor;
                const adjustedDeficit = calorieDeficit > 0 ? calorieDeficit : -calorieDeficit;
                const weightChange = (adjustedDeficit * 7) / 7700;
                current = calorieDeficit > 0 ? current - weightChange : current + weightChange;

                if (calorieDeficit > 0 && current <= targetWeight) {
                    weeksToTarget = i;
                    break;
                }
                if (calorieDeficit < 0 && current >= targetWeight) {
                    weeksToTarget = i;
                    break;
                }
            }

            forecastData = data;
            targetWeightValue = targetWeight;

            const today = new Date();
            const targetDate = new Date();
            targetDate.setDate(today.getDate() + weeksToTarget * 7);
            const targetDateStr = targetDate.toLocaleDateString('uk-UA', { day: 'numeric', month: 'long', year: 'numeric' });
            targetDateEl.textContent = `üìÖ –û—á—ñ–∫—É–≤–∞–Ω–∞ –¥–∞—Ç–∞ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –º–µ—Ç–∏: ${targetDateStr}`;

            if (weightHistory.length > 0) {
                const currentWeek = weightHistory.length;
                const actualWeight = weightHistory[currentWeek - 1].weight;
                const forecastWeight = forecastData[currentWeek] || forecastData[forecastData.length - 1];
                const difference = actualWeight - forecastWeight;
                if (difference < 0) {
                    paceIndicator.textContent = `üî∫ –¢–∏ –≤–∏–ø–µ—Ä–µ–¥–∂–∞—î—à –ø–ª–∞–Ω –Ω–∞ ${Math.abs(difference).toFixed(1)} –∫–≥`;
                } else if (difference > 0) {
                    paceIndicator.textContent = `üîª –¢–∏ –≤—ñ–¥—Å—Ç–∞—î—à –≤—ñ–¥ –ø–ª–∞–Ω—É –Ω–∞ ${difference.toFixed(1)} –∫–≥`;
                } else {
                    paceIndicator.textContent = `‚úÖ –¢–∏ –π–¥–µ—à –∑–∞ –ø–ª–∞–Ω–æ–º!`;
                }
            } else {
                paceIndicator.textContent = '';
            }

            motivationMessage.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];

            const actualData = weightHistory.map(entry => entry.weight);
            renderChart(labels.slice(0, data.length), data, actualData, weeksToTarget);

            const bmr = calculateBMR(currentWeight, height, age, gender);
            const tempComment = `–¢–≤—ñ–π BMR: ${bmr.toFixed(0)} –∫–∫–∞–ª. –ü—Ä–æ–≥–Ω–æ–∑: –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è —Ü—ñ–ª—ñ –∑–∞ ${weeksToTarget} —Ç–∏–∂–Ω—ñ–≤.`;
            const tempRecommendations = [
                "- –î–æ—Ç—Ä–∏–º—É–π—Å—è —Ü—ñ–ª—å–æ–≤–æ—ó –∫–∞–ª–æ—Ä—ñ–π–Ω–æ—Å—Ç—ñ.",
                "- –ó–±—ñ–ª—å—à –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±—ñ–ª–∫–∞ —É —Ä–∞—Ü—ñ–æ–Ω—ñ.",
                "- –î–æ–¥–∞–π –∫–∞—Ä–¥—ñ–æ –¥–ª—è –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É.",
                "- –í—ñ–¥—Å—Ç–µ–∂—É–π —Å–æ–Ω —ñ —Ä—ñ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—É."
            ];
            aiComment.textContent = tempComment;
            recommendationsList.innerHTML = tempRecommendations.map(item => `<li>${item}</li>`).join('');

            aiComment.classList.add('updated');
            setTimeout(() => {
                aiComment.classList.remove('updated');
            }, 1500);

            showToast('‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
            saveData();

            const question = `–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á, ${age} —Ä–æ–∫—ñ–≤, –∑—Ä—ñ—Å—Ç ${height} —Å–º, —Å—Ç–∞—Ç—å ${gender === 'male' ? '—á–æ–ª–æ–≤—ñ–∫' : '–∂—ñ–Ω–∫–∞'}, –≤–∞–≥–∞ ${currentWeight} –∫–≥, –º–µ—Ç–∞ ${targetWeight} –∫–≥. –°–ø–æ–∂–∏–≤–∞—î ${currentCalories} –∫–∫–∞–ª, —Ü—ñ–ª—å–æ–≤–∞ ${targetCalories} –∫–∫–∞–ª, ${workoutsPerWeek} —Ç—Ä–µ–Ω—É–≤–∞–Ω—å/—Ç–∏–∂–¥–µ–Ω—å. BMR: ${bmr.toFixed(0)} –∫–∫–∞–ª. –ü—Ä–æ–≥–Ω–æ–∑: ${weeksToTarget} —Ç–∏–∂–Ω—ñ. –ù–∞–ø–∏—à–∏ –ø—Ä–æ–≥–Ω–æ–∑ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –±–∞–∑–æ–≤–∏—Ö –º–µ—Ç–∞–±–æ–ª—ñ—á–Ω–∏—Ö –∑–º—ñ–Ω, –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π –ø–ª–∞—Ç–æ —Ç–∞ –º–æ—Ç–∏–≤–∞—Ü—ñ—ó. –¢–∞–∫–æ–∂ –¥–∞–π 4 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —É —Ñ–æ—Ä–º–∞—Ç—ñ —Å–ø–∏—Å–∫—É: "- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è 1".join('')`;
            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question })
            })
            .then(response => {
                if (!response.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î');
                return response.json();
            })
            .then(data => {
                const responseText = data.answer;
                const [comment, recommendations] = responseText.split('\n\n-');
                aiComment.textContent = comment.trim();
                const recItems = recommendations ? recommendations.split('\n-').filter(item => item.trim()).map(item => item.trim()) : [];
                recommendationsList.innerHTML = recItems.map(item => `<li>${item}</li>`).join('');

                aiComment.classList.add('updated');
                setTimeout(() => {
                    aiComment.classList.remove('updated');
                }, 1500);

                showToast('‚úÖ –ü—Ä–æ–≥–Ω–æ–∑ –æ–Ω–æ–≤–ª–µ–Ω–æ –∑ AI!');
                saveData();
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ AI:', error);
            });
        }

        function renderChart(labels, forecastData, actualData, weeksToTarget) {
            if (chart) chart.destroy();
            const targetWeight = targetWeightValue;
            const currentWeight = forecastData[0];
            const isWeightLoss = targetWeight < currentWeight;
            const isWeightGain = targetWeight > currentWeight;
            const borderColor = isWeightLoss ? 'rgba(0, 255, 0, 1)' : isWeightGain ? 'rgba(0, 0, 255, 1)' : 'rgba(128, 128, 128, 1)';
            const backgroundColor = isWeightLoss ? 'rgba(0, 255, 0, 0.2)' : isWeightGain ? 'rgba(0, 0, 255, 0.2)' : 'rgba(128, 128, 128, 0.2)';

            const datasets = [
                {
                    label: '–ü—Ä–æ–≥–Ω–æ–∑ –≤–∞–≥–∏ (–∫–≥)',
                    data: forecastData,
                    borderColor: borderColor,
                    backgroundColor: backgroundColor,
                    fill: true,
                    tension: 0.3
                }
            ];

            if (actualData.length) {
                datasets.push({
                    label: '–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞ (–∫–≥)',
                    data: actualData,
                    borderColor: 'rgba(255, 215, 0, 1)',
                    backgroundColor: 'rgba(255, 215, 0, 0.2)',
                    fill: false,
                    borderDash: [5, 5],
                    tension: 0.1
                });
            }

            const annotations = (targetWeight && typeof window.ChartAnnotation !== 'undefined') ? {
                targetLine: {
                    type: 'line',
                    yMin: targetWeight,
                    yMax: targetWeight,
                    borderColor: 'rgba(255, 215, 0, 0.7)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        display: true,
                        content: '–¶—ñ–ª—å: ' + targetWeight.toFixed(1) + ' –∫–≥',
                        position: 'start',
                        backgroundColor: 'rgba(255, 215, 0, 0.8)',
                        color: '#1A1A1A',
                        font: { size: 12, weight: 600 },
                        padding: 6
                    }
                },
                completionPoint: weeksToTarget ? {
                    type: 'point',
                    xValue: weeksToTarget,
                    yValue: targetWeight,
                    backgroundColor: 'rgba(0, 255, 209, 0.9)',
                    borderColor: 'rgba(0, 255, 209, 1)',
                    radius: 6,
                    label: {
                        display: true,
                        content: '–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è',
                        position: 'top',
                        backgroundColor: 'rgba(0, 255, 209, 0.8)',
                        color: '#1A1A1A',
                        font: { size: 12, weight: 600 },
                        padding: 6
                    }
                } : null
            } : {};

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    scales: {
                        x: { title: { display: true, text: '–¢–∏–∂–Ω—ñ', color: '#A0AEC0' }, ticks: { color: '#A0AEC0' } },
                        y: { title: { display: true, text: '–í–∞–≥–∞ (–∫–≥)', color: '#A0AEC0' }, ticks: { color: '#A0AEC0' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#A0AEC0' } },
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)} –∫–≥` } },
                        annotation: {
                            annotations: annotations
                        }
                    }
                }
            });
        }

        document.getElementById('simCal').addEventListener('input', function() {
            document.getElementById('simCalValue').textContent = this.value;
            calculateForecast();
        });

        document.getElementById('simulateExtraWorkout').addEventListener('change', calculateForecast);

        document.getElementById('currentWeight').addEventListener('input', updateProgressBar);
        document.getElementById('targetWeight').addEventListener('input', calculateForecast);

        window.onload = loadData;
    </script>
</body>
</html>